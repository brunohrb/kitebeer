<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotyfi do Carnaval - Acerto de Contas</title>
    <style>
        /* --- TEMA "SPOTYFI" --- */
        :root {
            --bg-main: #121212;
            --bg-card: #181818;
            --bg-input: #282828;
            --primary: #1DB954;
            --text-light: #FFFFFF;
            --text-muted: #B3B3B3;
            --danger: #E91429;
            --border-radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body { background-color: var(--bg-main); color: var(--text-light); padding-bottom: 80px;}

        header {
            background: linear-gradient(180deg, rgba(29,185,84,0.15) 0%, var(--bg-main) 100%);
            padding: 1.5rem 1rem;
            text-align: center;
        }

        .container { max-width: 500px; margin: 0 auto; padding: 15px; }

        .card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        h2 { font-size: 1.1rem; margin-bottom: 15px; color: var(--text-light); font-weight: 600; display:flex; align-items:center; gap:10px;}

        /* Inputs */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; font-weight: 600;}
        
        input, select {
            width: 100%; padding: 14px; background-color: var(--bg-input);
            border: 1px solid transparent; color: var(--text-light);
            border-radius: 6px; font-size: 1rem;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); }

        /* Bot√µes */
        button {
            width: 100%; padding: 16px; border: none; border-radius: 50px;
            background-color: var(--primary); color: #000;
            font-weight: bold; font-size: 1.1rem; cursor: pointer;
            transition: 0.2s;
        }
        button:hover { transform: scale(1.02); filter: brightness(1.1); }
        button.secondary { background: transparent; border: 1px solid #555; color: #fff; margin-top: 10px; }
        button.small-btn { width: auto; padding: 14px 20px; border-radius: 6px; }

        /* Checkboxes e Tags */
        .participants-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .participant-option input { display: none; }
        .participant-option label {
            display: block; background: var(--bg-input); color: var(--text-muted);
            padding: 10px 16px; border-radius: 50px; cursor: pointer; border: 1px solid #333;
        }
        .participant-option input:checked + label {
            background-color: var(--primary); color: #000; border-color: var(--primary); font-weight: bold;
        }
        .person-tag { background: #333; padding: 5px 12px; border-radius: 50px; font-size: 0.85rem; }

        /* Estilo do Plano de Pagamento (NOVO) */
        .payment-plan-item {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 4px solid var(--primary);
        }
        .pay-arrow { color: var(--text-muted); margin: 0 10px; font-size: 1.2rem; }
        .pay-amount { color: var(--primary); font-weight: bold; font-size: 1.1rem; }

        /* Hist√≥rico */
        .expense-item {
            display: flex; justify-content: space-between; padding: 15px;
            background: var(--bg-input); margin-bottom: 10px; border-radius: 8px;
        }
        .delete-btn { width: 30px; height: 30px; padding: 0; background: transparent; color: #666; font-size: 1.2rem;}
    </style>
</head>
<body>

<header>
    <h1>$ Spotyfi do Carnaval</h1>
</header>

<div class="container">

    <div class="card" style="border: 1px solid var(--primary);">
        <h2>‚úÖ Como acertas as contas:</h2>
        <div id="paymentPlanList">
            <p style="text-align:center; color:var(--text-muted); padding: 10px;">Lance os gastos para gerar o plano.</p>
        </div>
    </div>

    <div class="card">
        <h2>üìä Saldo L√≠quido (Resumo)</h2>
        <div id="balanceList"></div>
    </div>

    <div class="card">
        <h2>üë• Novo Foli√£o</h2>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="newPersonName" placeholder="Nome">
            <button onclick="addPerson()" class="small-btn">+</button>
        </div>
        <div id="peopleTags" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
    </div>

    <div class="card">
        <h2>üí∏ Lan√ßar Gasto</h2>
        <div class="form-group">
            <input type="text" id="descInput" placeholder="Descri√ß√£o (ex: Uber, Cerveja)">
        </div>
        <div class="form-group">
            <input type="number" id="amountInput" placeholder="Valor (R$)" step="0.01">
        </div>
        <div class="form-group">
            <label>Quem pagou?</label>
            <select id="payerSelect"><option value="" disabled selected>Selecione...</option></select>
        </div>
        <div class="form-group">
            <label style="color: var(--primary);">Para quem foi? (Marque os envolvidos)</label>
            <div id="participantsContainer" class="participants-grid"></div>
        </div>
        <button onclick="addExpense()">SALVAR</button>
    </div>

    <div class="card">
        <h2>üìú Hist√≥rico</h2>
        <ul id="expensesList"></ul>
        <button class="secondary" onclick="resetApp()">Reiniciar Tudo</button>
    </div>
</div>

<script>
    let people = [];
    let expenses = [];

    // --- Elementos ---
    const payerSelect = document.getElementById('payerSelect');
    const participantsContainer = document.getElementById('participantsContainer');
    const expensesList = document.getElementById('expensesList');
    const balanceList = document.getElementById('balanceList');
    const paymentPlanList = document.getElementById('paymentPlanList');
    const peopleTags = document.getElementById('peopleTags');

    // --- Fun√ß√µes B√°sicas ---
    function addPerson() {
        const name = document.getElementById('newPersonName').value.trim();
        if (name && !people.includes(name)) {
            people.push(name);
            document.getElementById('newPersonName').value = '';
            updateUI();
        } else if (people.includes(name)) alert('J√° existe!');
    }

    function addExpense() {
        const desc = document.getElementById('descInput').value.trim();
        const amount = parseFloat(document.getElementById('amountInput').value);
        const payer = payerSelect.value;
        const checkboxes = document.querySelectorAll('.participant-checkbox:checked');
        const involved = Array.from(checkboxes).map(cb => cb.value);

        if (!desc || isNaN(amount) || amount <= 0 || !payer || involved.length === 0) {
            alert('Preencha todos os dados corretamente.');
            return;
        }

        expenses.push({ id: Date.now(), desc, amount, payer, involved });
        
        document.getElementById('descInput').value = '';
        document.getElementById('amountInput').value = '';
        updateUI();
    }

    function removeExpense(id) {
        if(confirm('Apagar despesa?')) {
            expenses = expenses.filter(e => e.id !== id);
            updateUI();
        }
    }

    // --- Atualiza√ß√£o Visual ---
    function updateUI() {
        renderPeopleRelated();
        renderExpenses();
        calculateAndRenderBalances();
    }

    function renderPeopleRelated() {
        // Tags
        peopleTags.innerHTML = people.map(p => `<span class="person-tag">${p}</span>`).join('');
        
        // Select
        const currentPayer = payerSelect.value;
        payerSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
        people.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p; opt.textContent = p;
            payerSelect.appendChild(opt);
        });
        if(people.includes(currentPayer)) payerSelect.value = currentPayer;

        // Checkboxes (s√≥ recria se mudou numero de pessoas para n√£o perder sele√ß√£o atual durante uso)
        if(participantsContainer.children.length !== people.length && people.length > 0) {
            participantsContainer.innerHTML = '';
            people.forEach(p => {
                const div = document.createElement('div');
                div.className = 'participant-option';
                div.innerHTML = `<input type="checkbox" id="cb_${p}" value="${p}" class="participant-checkbox" checked><label for="cb_${p}">${p}</label>`;
                participantsContainer.appendChild(div);
            });
        }
    }

    function renderExpenses() {
        expensesList.innerHTML = '';
        expenses.slice().reverse().forEach(exp => {
            const li = document.createElement('li');
            li.className = 'expense-item';
            li.innerHTML = `
                <div>
                    <strong>${exp.desc}</strong>
                    <small style="color:#888">${exp.payer} pagou R$ ${exp.amount.toFixed(2)}</small>
                </div>
                <div style="display:flex; align-items:center; gap:10px">
                    <span style="color:var(--primary)">R$ ${exp.amount.toFixed(2)}</span>
                    <button class="delete-btn" onclick="removeExpense(${exp.id})">‚úï</button>
                </div>`;
            expensesList.appendChild(li);
        });
    }

    // --- O CORA√á√ÉO DO C√ÅLCULO (QUEM PAGA QUEM) ---
    function calculateAndRenderBalances() {
        if (people.length === 0) return;

        // 1. Calcular Saldo L√≠quido
        let balances = {};
        people.forEach(p => balances[p] = 0);

        expenses.forEach(exp => {
            const share = exp.amount / exp.involved.length;
            if (people.includes(exp.payer)) balances[exp.payer] += exp.amount;
            exp.involved.forEach(p => { if (balances.hasOwnProperty(p)) balances[p] -= share; });
        });

        // 2. Renderizar Resumo (Saldo L√≠quido)
        balanceList.innerHTML = '';
        Object.keys(balances).forEach(p => {
            if(Math.abs(balances[p]) < 0.01) return;
            const color = balances[p] > 0 ? 'var(--primary)' : 'var(--danger)';
            const text = balances[p] > 0 ? 'recebe' : 'deve';
            balanceList.innerHTML += `<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #333;">
                <span>${p}</span><span style="color:${color}">${text} R$ ${Math.abs(balances[p]).toFixed(2)}</span>
            </div>`;
        });

        // 3. ALGORITMO DE OTIMIZA√á√ÉO DE PAGAMENTOS
        // Separa quem deve (devedores) de quem tem a receber (credores)
        let debtors = [];
        let creditors = [];

        for (const [person, amount] of Object.entries(balances)) {
            if (amount < -0.01) debtors.push({ name: person, amount: Math.abs(amount) });
            if (amount > 0.01) creditors.push({ name: person, amount: amount });
        }

        // Ordena para facilitar (opcional, mas ajuda na visualiza√ß√£o)
        debtors.sort((a, b) => b.amount - a.amount);
        creditors.sort((a, b) => b.amount - a.amount);

        paymentPlanList.innerHTML = '';
        let hasPayments = false;

        // Cruzamento de dados
        let i = 0; // √çndice devedores
        let j = 0; // √çndice credores

        while (i < debtors.length && j < creditors.length) {
            hasPayments = true;
            let debtor = debtors[i];
            let creditor = creditors[j];

            // O valor a ser pago √© o m√≠nimo entre o que um deve e o outro tem a receber
            let amountToPay = Math.min(debtor.amount, creditor.amount);

            // Gera o HTML da instru√ß√£o
            const div = document.createElement('div');
            div.className = 'payment-plan-item';
            div.innerHTML = `
                <div style="display:flex; align-items:center; width:100%;">
                    <span style="color:var(--danger)">${debtor.name}</span>
                    <span class="pay-arrow">‚ûî</span>
                    <span style="color:var(--primary)">${creditor.name}</span>
                </div>
                <div class="pay-amount">R$ ${amountToPay.toFixed(2)}</div>
            `;
            paymentPlanList.appendChild(div);

            // Atualiza os valores restantes
            debtor.amount -= amountToPay;
            creditor.amount -= amountToPay;

            // Se zerou a d√≠vida, passa para o pr√≥ximo devedor
            if (debtor.amount < 0.01) i++;
            // Se zerou o cr√©dito, passa para o pr√≥ximo credor
            if (creditor.amount < 0.01) j++;
        }

        if (!hasPayments) {
            paymentPlanList.innerHTML = '<p style="text-align:center; color:var(--primary);">Ningu√©m deve nada!</p>';
        }
    }

    function resetApp() {
        if(confirm("Reiniciar tudo?")) {
            people = []; expenses = []; updateUI();
        }
    }
</script>

</body>
</html>
