<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotyfi do Carnaval - Acerto de Contas</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- TEMA "SPOTYFI" --- */
        :root {
            --bg-main: #121212;
            --bg-card: #181818;
            --bg-input: #282828;
            --primary: #1DB954;
            --text-light: #FFFFFF;
            --text-muted: #B3B3B3;
            --danger: #E91429;
            --border-radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body { background-color: var(--bg-main); color: var(--text-light); padding-bottom: 80px;}

        header {
            background: linear-gradient(180deg, rgba(29,185,84,0.15) 0%, var(--bg-main) 100%);
            padding: 1.5rem 1rem;
            text-align: center;
        }

        .container { max-width: 500px; margin: 0 auto; padding: 15px; }

        .card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        h2 { font-size: 1.1rem; margin-bottom: 15px; color: var(--text-light); font-weight: 600; display:flex; align-items:center; gap:10px;}

        /* Inputs */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; font-weight: 600;}
        
        input, select {
            width: 100%; padding: 14px; background-color: var(--bg-input);
            border: 1px solid transparent; color: var(--text-light);
            border-radius: 6px; font-size: 1rem;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); }

        /* Bot√µes */
        button {
            width: 100%; padding: 16px; border: none; border-radius: 50px;
            background-color: var(--primary); color: #000;
            font-weight: bold; font-size: 1.1rem; cursor: pointer;
            transition: 0.2s;
            position: relative;
        }
        button:hover { transform: scale(1.02); filter: brightness(1.1); }
        button:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        button.secondary { background: transparent; border: 1px solid #555; color: #fff; margin-top: 10px; }
        button.small-btn { width: auto; padding: 14px 20px; border-radius: 6px; }
        button.danger { background-color: var(--danger); }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 0, 0, 0.3);
            border-top: 2px solid #000;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        .spinner.white {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #fff;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Overlay de Loading Global */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-overlay .spinner-big {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(29, 185, 84, 0.3);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-overlay p {
            margin-top: 20px;
            color: var(--text-light);
            font-size: 1rem;
        }

        /* Checkboxes e Tags */
        .participants-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .participant-option input { display: none; }
        .participant-option label {
            display: block; background: var(--bg-input); color: var(--text-muted);
            padding: 10px 16px; border-radius: 50px; cursor: pointer; border: 1px solid #333;
        }
        .participant-option input:checked + label {
            background-color: var(--primary); color: #000; border-color: var(--primary); font-weight: bold;
        }
        
        /* Tags de Pessoas com Bot√£o de Excluir */
        .person-tag { 
            background: #333; 
            padding: 5px 12px; 
            border-radius: 50px; 
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .person-tag .delete-person-btn {
            background: none;
            border: none;
            color: #ff4444;
            cursor: pointer;
            padding: 0;
            font-size: 1rem;
            width: auto;
            line-height: 1;
        }
        .person-tag .delete-person-btn:hover {
            color: #ff6666;
            transform: none;
        }

        /* Estilo do Plano de Pagamento */
        .payment-plan-item {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 4px solid var(--primary);
        }
        .pay-arrow { color: var(--text-muted); margin: 0 10px; font-size: 1.2rem; }
        .pay-amount { color: var(--primary); font-weight: bold; font-size: 1.1rem; }

        /* Hist√≥rico */
        .expense-item {
            display: flex; justify-content: space-between; padding: 15px;
            background: var(--bg-input); margin-bottom: 10px; border-radius: 8px;
        }
        .delete-btn { width: 30px; height: 30px; padding: 0; background: transparent; color: #666; font-size: 1.2rem;}

        /* Tela de Login/Criar Grupo */
        #authScreen { display: block; }
        #appScreen { display: none; }
        
        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .auth-tab {
            flex: 1;
            padding: 12px;
            background: var(--bg-input);
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            font-weight: 600;
        }
        .auth-tab.active {
            background: var(--primary);
            color: #000;
        }

        .grupo-info {
            background: var(--bg-input);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

<!-- Loading Overlay Global -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-big"></div>
    <p id="loadingText">Carregando...</p>
</div>

<header>
    <h1>üé≠ Spotyfi do Carnaval</h1>
</header>

<!-- TELA DE AUTENTICA√á√ÉO -->
<div id="authScreen" class="container">
    <div class="card">
        <div class="auth-tabs">
            <button class="auth-tab active" id="tabBtnEntrar">ENTRAR</button>
            <button class="auth-tab" id="tabBtnCriar">CRIAR GRUPO</button>
        </div>

        <!-- ABA ENTRAR -->
        <div id="tabEntrar">
            <h2>üîë Entrar no Grupo</h2>
            <div class="form-group">
                <label>C√≥digo do Grupo</label>
                <input type="text" id="loginCodigo" placeholder="Ex: CARNA26" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>Senha</label>
                <input type="password" id="loginSenha" placeholder="Digite a senha">
            </div>
            <button id="btnEntrar">ENTRAR</button>
        </div>

        <!-- ABA CRIAR -->
        <div id="tabCriar" class="hidden">
            <h2>‚ú® Criar Novo Grupo</h2>
            <div class="form-group">
                <label>Nome do Grupo</label>
                <input type="text" id="criarNome" placeholder="Ex: Carnaval Salvador 2026">
            </div>
            <div class="form-group">
                <label>Senha (m√≠nimo 4 caracteres)</label>
                <input type="password" id="criarSenha" placeholder="Crie uma senha">
            </div>
            <div class="form-group">
                <label>Seu Nome</label>
                <input type="text" id="criarCriador" placeholder="Quem est√° criando?">
            </div>
            <button id="btnCriar">CRIAR GRUPO</button>
        </div>
    </div>
</div>

<!-- TELA PRINCIPAL DO APP -->
<div id="appScreen" class="container">
    
    <!-- INFO DO GRUPO -->
    <div class="grupo-info">
        <div>
            <strong id="grupoNome"></strong><br>
            <small style="color: var(--text-muted);">C√≥digo: <span id="grupoCodigo"></span></small>
        </div>
        <button class="small-btn danger" id="btnSair">SAIR</button>
    </div>

    <div class="card" style="border: 1px solid var(--primary);">
        <h2>‚úÖ Como acertar as contas:</h2>
        <div id="paymentPlanList">
            <p style="text-align:center; color:var(--text-muted); padding: 10px;">Lance os gastos para gerar o plano.</p>
        </div>
    </div>

    <div class="card">
        <h2>üìä Saldo L√≠quido (Resumo)</h2>
        <div id="balanceList"></div>
    </div>

    <div class="card">
        <h2>üë• Foli√µes do Grupo</h2>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="newPersonName" placeholder="Nome do participante">
            <button id="btnAddPerson" class="small-btn">+</button>
        </div>
        <div id="peopleTags" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
    </div>

    <div class="card">
        <h2>üí∏ Lan√ßar Gasto</h2>
        <div class="form-group">
            <input type="text" id="descInput" placeholder="Descri√ß√£o (ex: Uber, Cerveja)">
        </div>
        <div class="form-group">
            <input type="number" id="amountInput" placeholder="Valor (R$)" step="0.01">
        </div>
        <div class="form-group">
            <label>Quem pagou?</label>
            <select id="payerSelect"><option value="" disabled selected>Selecione...</option></select>
        </div>
        <div class="form-group">
            <label style="color: var(--primary);">Para quem foi? (Marque os envolvidos)</label>
            <div id="participantsContainer" class="participants-grid"></div>
        </div>
        <button id="btnAddExpense">SALVAR</button>
    </div>

    <div class="card">
        <h2>üìú Hist√≥rico</h2>
        <div id="expensesList"></div>
        <button class="secondary" id="btnLimparDespesas">Limpar Todas as Despesas</button>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // ========================================
    // ‚ö†Ô∏è CREDENCIAIS DO SUPABASE ‚ö†Ô∏è
    // ========================================
    const SUPABASE_URL = 'https://fwhsjzkmnfxnlrvspkyr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3aHNqemttbmZ4bmxydnNwa3lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0Nzg3MzUsImV4cCI6MjA4MzA1NDczNX0.lT_tHpkxiOQl2HdsFc5VQr_xfkEvoGi101MaITnSLkc';
    // ========================================

    console.log('üöÄ Iniciando aplica√ß√£o...');

    // Criar cliente Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    console.log('‚úÖ Cliente Supabase criado');

    // ========================================
    // FUN√á√ïES DE LOADING
    // ========================================
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');

    function showLoading(message = 'Carregando...') {
        loadingText.textContent = message;
        loadingOverlay.classList.add('active');
    }

    function hideLoading() {
        loadingOverlay.classList.remove('active');
    }

    function setButtonLoading(button, loading, originalText) {
        if (loading) {
            button.disabled = true;
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span>' + originalText;
        } else {
            button.disabled = false;
            button.innerHTML = button.dataset.originalText || originalText;
        }
    }

    // ========================================
    // VARI√ÅVEIS GLOBAIS
    // ========================================
    let grupoAtual = null;
    let people = [];
    let expenses = [];

    // Elementos DOM
    const authScreen = document.getElementById('authScreen');
    const appScreen = document.getElementById('appScreen');
    const payerSelect = document.getElementById('payerSelect');
    const participantsContainer = document.getElementById('participantsContainer');
    const expensesList = document.getElementById('expensesList');
    const balanceList = document.getElementById('balanceList');
    const paymentPlanList = document.getElementById('paymentPlanList');
    const peopleTags = document.getElementById('peopleTags');

    // ========================================
    // INICIALIZA√á√ÉO
    // ========================================
    window.addEventListener('load', function() {
        console.log('üìÑ P√°gina carregada');
        
        const grupoSalvo = localStorage.getItem('grupoAtual');
        if (grupoSalvo) {
            grupoAtual = JSON.parse(grupoSalvo);
            console.log('üìÇ Grupo recuperado:', grupoAtual);
            mostrarApp();
            carregarDados();
        }

        // Event Listeners
        document.getElementById('tabBtnEntrar').addEventListener('click', () => switchTab('entrar'));
        document.getElementById('tabBtnCriar').addEventListener('click', () => switchTab('criar'));
        document.getElementById('btnEntrar').addEventListener('click', entrarNoGrupo);
        document.getElementById('btnCriar').addEventListener('click', criarGrupo);
        document.getElementById('btnSair').addEventListener('click', sairDoGrupo);
        document.getElementById('btnAddPerson').addEventListener('click', addPerson);
        document.getElementById('btnAddExpense').addEventListener('click', addExpense);
        document.getElementById('btnLimparDespesas').addEventListener('click', limparDespesas);
    });

    // ========================================
    // AUTENTICA√á√ÉO
    // ========================================

    function switchTab(tab) {
        console.log('Mudando para aba:', tab);
        const tabEntrar = document.getElementById('tabEntrar');
        const tabCriar = document.getElementById('tabCriar');
        const btnEntrar = document.getElementById('tabBtnEntrar');
        const btnCriar = document.getElementById('tabBtnCriar');
        
        btnEntrar.classList.remove('active');
        btnCriar.classList.remove('active');
        
        if (tab === 'entrar') {
            tabEntrar.classList.remove('hidden');
            tabCriar.classList.add('hidden');
            btnEntrar.classList.add('active');
        } else {
            tabEntrar.classList.add('hidden');
            tabCriar.classList.remove('hidden');
            btnCriar.classList.add('active');
        }
    }

    async function criarGrupo() {
        console.log('üìù Iniciando cria√ß√£o de grupo...');
        
        const nome = document.getElementById('criarNome').value.trim();
        const senha = document.getElementById('criarSenha').value;
        const criador = document.getElementById('criarCriador').value.trim();

        console.log('Dados:', { nome, senha: senha ? '***' : '', criador });

        if (!nome || !senha || !criador) {
            alert('Preencha todos os campos!');
            return;
        }

        if (senha.length < 4) {
            alert('A senha deve ter no m√≠nimo 4 caracteres!');
            return;
        }

        const codigo = Math.random().toString(36).substring(2, 8).toUpperCase();
        console.log('C√≥digo gerado:', codigo);

        const btn = document.getElementById('btnCriar');
        setButtonLoading(btn, true, 'Criando...');

        try {
            console.log('üì§ Enviando para Supabase...');
            
            const { data, error } = await supabase
                .from('grupos')
                .insert([{ 
                    nome: nome,
                    senha: senha,
                    codigo_acesso: codigo,
                    criado_por: criador
                }])
                .select()
                .single();

            console.log('üì• Resposta:', { data, error });

            if (error) {
                console.error('‚ùå Erro:', error);
                
                if (error.code === '42P01') {
                    alert('‚ùå Tabela n√£o existe!\n\nExecute o SQL no Supabase.');
                } else if (error.code === '42501') {
                    alert('‚ùå Sem permiss√£o!\n\nExecute:\nALTER TABLE grupos DISABLE ROW LEVEL SECURITY;');
                } else {
                    alert('Erro: ' + error.message);
                }
                return;
            }

            console.log('‚úÖ Grupo criado com sucesso!', data);
            grupoAtual = data;
            localStorage.setItem('grupoAtual', JSON.stringify(data));

            alert(`üéâ Grupo criado!\n\nüìå C√≥digo: ${codigo}\nüîí Senha: ${senha}\n\nCompartilhe!`);
            
            mostrarApp();
            carregarDados();

        } catch (error) {
            console.error('‚ùå Erro cr√≠tico:', error);
            alert('Erro: ' + error.message);
        } finally {
            setButtonLoading(btn, false, 'CRIAR GRUPO');
        }
    }

    async function entrarNoGrupo() {
        console.log('üîë Tentando entrar no grupo...');
        
        const codigo = document.getElementById('loginCodigo').value.trim().toUpperCase();
        const senha = document.getElementById('loginSenha').value;

        if (!codigo || !senha) {
            alert('Preencha o c√≥digo e a senha!');
            return;
        }

        const btn = document.getElementById('btnEntrar');
        setButtonLoading(btn, true, 'Entrando...');

        try {
            const { data, error } = await supabase
                .from('grupos')
                .select('*')
                .eq('codigo_acesso', codigo)
                .eq('senha', senha)
                .eq('ativo', true)
                .single();

            if (error || !data) {
                console.error('Erro:', error);
                alert('‚ùå C√≥digo ou senha incorretos!');
                return;
            }

            console.log('‚úÖ Entrou no grupo:', data);
            grupoAtual = data;
            localStorage.setItem('grupoAtual', JSON.stringify(data));

            alert(`‚úÖ Bem-vindo ao grupo: ${data.nome}!`);
            
            mostrarApp();
            carregarDados();

        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao entrar.');
        } finally {
            setButtonLoading(btn, false, 'ENTRAR');
        }
    }

    function sairDoGrupo() {
        if (confirm('Deseja sair do grupo?')) {
            grupoAtual = null;
            people = [];
            expenses = [];
            localStorage.removeItem('grupoAtual');
            
            authScreen.style.display = 'block';
            appScreen.style.display = 'none';
            
            document.getElementById('loginCodigo').value = '';
            document.getElementById('loginSenha').value = '';
            
            console.log('üëã Saiu do grupo');
        }
    }

    function mostrarApp() {
        authScreen.style.display = 'none';
        appScreen.style.display = 'block';
        
        document.getElementById('grupoNome').textContent = grupoAtual.nome;
        document.getElementById('grupoCodigo').textContent = grupoAtual.codigo_acesso;
    }

    // ========================================
    // CARREGAR DADOS
    // ========================================

    async function carregarDados() {
        if (!grupoAtual) return;
        showLoading('Carregando dados do grupo...');
        try {
            await carregarParticipantes();
            await carregarDespesas();
        } finally {
            hideLoading();
        }
    }

    async function carregarParticipantes() {
        if (!grupoAtual) return;

        try {
            const { data, error } = await supabase
                .from('participantes')
                .select('nome')
                .eq('grupo_id', grupoAtual.id)
                .order('nome');

            if (error) throw error;

            people = data ? data.map(p => p.nome) : [];
            updateUI();

        } catch (error) {
            console.error('Erro ao carregar participantes:', error);
        }
    }

    async function carregarDespesas() {
        if (!grupoAtual) return;

        try {
            const { data, error } = await supabase
                .from('despesas')
                .select(`
                    id,
                    descricao,
                    valor,
                    pagador,
                    criado_em,
                    despesas_envolvidos (
                        participante_nome
                    )
                `)
                .eq('grupo_id', grupoAtual.id)
                .order('criado_em', { ascending: false });

            if (error) throw error;

            expenses = data ? data.map(d => ({
                id: d.id,
                desc: d.descricao,
                amount: parseFloat(d.valor),
                payer: d.pagador,
                involved: d.despesas_envolvidos.map(e => e.participante_nome)
            })) : [];

            updateUI();

        } catch (error) {
            console.error('Erro ao carregar despesas:', error);
        }
    }

    // ========================================
    // ADICIONAR PARTICIPANTE
    // ========================================

    async function addPerson() {
        const name = document.getElementById('newPersonName').value.trim();
        
        if (!name) {
            alert('Digite um nome!');
            return;
        }

        if (!grupoAtual) {
            alert('Erro: grupo n√£o identificado!');
            return;
        }

        if (people.includes(name)) {
            alert('Este nome j√° existe!');
            return;
        }

        const btn = document.getElementById('btnAddPerson');
        setButtonLoading(btn, true, 'Adicionando...');

        try {
            const { data, error } = await supabase
                .from('participantes')
                .insert([{ grupo_id: grupoAtual.id, nome: name }])
                .select();

            if (error) {
                if (error.code === '23505') alert('Nome j√° existe!');
                throw error;
            }

            people.push(name);
            document.getElementById('newPersonName').value = '';
            updateUI();

        } catch (error) {
            console.error('Erro:', error);
        } finally {
            setButtonLoading(btn, false, '+');
        }
    }

    // ========================================
    // EXCLUIR PARTICIPANTE
    // ========================================

    async function deletePerson(nome) {
        // Verificar se tem despesas
        const temDespesas = expenses.some(exp => 
            exp.payer === nome || exp.involved.includes(nome)
        );

        if (temDespesas) {
            alert(`‚ùå N√£o √© poss√≠vel excluir ${nome}!\n\nEsta pessoa tem despesas lan√ßadas.\nRemova as despesas primeiro.`);
            return;
        }

        if (!confirm(`Excluir ${nome} do grupo?`)) return;

        showLoading('Removendo foli√£o...');

        try {
            const { error } = await supabase
                .from('participantes')
                .delete()
                .eq('grupo_id', grupoAtual.id)
                .eq('nome', nome);

            if (error) throw error;

            people = people.filter(p => p !== nome);
            updateUI();

        } catch (error) {
            console.error('Erro ao excluir participante:', error);
            alert('Erro ao excluir participante.');
        } finally {
            hideLoading();
        }
    }

    // Tornar global para onclick
    window.deletePerson = deletePerson;

    // ========================================
    // ADICIONAR DESPESA (OTIMIZADO!)
    // ========================================

    async function addExpense() {
        const desc = document.getElementById('descInput').value.trim();
        const amount = parseFloat(document.getElementById('amountInput').value);
        const payer = payerSelect.value;
        const checkboxes = document.querySelectorAll('.participant-checkbox:checked');
        const involved = Array.from(checkboxes).map(cb => cb.value);

        if (!desc || isNaN(amount) || amount <= 0 || !payer || involved.length === 0) {
            alert('Preencha todos os dados!');
            return;
        }

        if (!grupoAtual) {
            alert('Erro: grupo n√£o identificado!');
            return;
        }

        const btn = document.getElementById('btnAddExpense');
        setButtonLoading(btn, true, 'Salvando...');

        try {
            // TENTAR usar a fun√ß√£o otimizada primeiro
            const { data: funcData, error: funcError } = await supabase
                .rpc('adicionar_despesa_completa', {
                    p_grupo_id: grupoAtual.id,
                    p_descricao: desc,
                    p_valor: amount,
                    p_pagador: payer,
                    p_envolvidos: involved
                });

            // Se a fun√ß√£o n√£o existe, usar m√©todo tradicional
            if (funcError && funcError.code === '42883') {
                console.log('‚ö†Ô∏è Fun√ß√£o otimizada n√£o encontrada. Usando m√©todo tradicional...');
                await addExpenseTradicional(desc, amount, payer, involved);
            } else if (funcError) {
                throw funcError;
            } else {
                console.log('‚úÖ Despesa adicionada com fun√ß√£o otimizada!');
            }

            document.getElementById('descInput').value = '';
            document.getElementById('amountInput').value = '';
            
            await carregarDespesas();

        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao salvar despesa.');
        } finally {
            setButtonLoading(btn, false, 'SALVAR');
        }
    }

    // M√©todo tradicional (fallback caso a fun√ß√£o SQL n√£o exista)
    async function addExpenseTradicional(desc, amount, payer, involved) {
        const { data: despesaData, error: despesaError } = await supabase
            .from('despesas')
            .insert([{
                grupo_id: grupoAtual.id,
                descricao: desc,
                valor: amount,
                pagador: payer
            }])
            .select()
            .single();

        if (despesaError) throw despesaError;

        const { data: participantesData, error: participantesError } = await supabase
            .from('participantes')
            .select('id, nome')
            .eq('grupo_id', grupoAtual.id)
            .in('nome', involved);

        if (participantesError) throw participantesError;

        const envolvidos = participantesData.map(p => ({
            despesa_id: despesaData.id,
            participante_nome: p.nome,
            participante_id: p.id
        }));

        const { error: envolvidosError } = await supabase
            .from('despesas_envolvidos')
            .insert(envolvidos);

        if (envolvidosError) throw envolvidosError;
    }

    // ========================================
    // REMOVER DESPESA
    // ========================================

    window.removeExpense = async function(id) {
        if (!confirm('Apagar esta despesa?')) return;

        showLoading('Removendo despesa...');

        try {
            const { error } = await supabase
                .from('despesas')
                .delete()
                .eq('id', id);

            if (error) throw error;

            await carregarDespesas();

        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao remover despesa.');
        } finally {
            hideLoading();
        }
    };

    // ========================================
    // LIMPAR DESPESAS
    // ========================================

    async function limparDespesas() {
        if (!confirm('Limpar TODAS as despesas?')) return;

        const btn = document.getElementById('btnLimparDespesas');
        setButtonLoading(btn, true, 'Limpando...');

        try {
            const { error } = await supabase
                .from('despesas')
                .delete()
                .eq('grupo_id', grupoAtual.id);

            if (error) throw error;

            expenses = [];
            updateUI();
            alert('Despesas removidas!');

        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao limpar despesas.');
        } finally {
            setButtonLoading(btn, false, 'Limpar Todas as Despesas');
        }
    }

    // ========================================
    // INTERFACE
    // ========================================

    function updateUI() {
        renderPeopleRelated();
        renderExpenses();
        calculateAndRenderBalances();
    }

    function renderPeopleRelated() {
        // Renderizar tags com bot√£o de excluir
        peopleTags.innerHTML = people.map(p => `
            <span class="person-tag">
                ${p}
                <button class="delete-person-btn" onclick="deletePerson('${p}')" title="Excluir">√ó</button>
            </span>
        `).join('');
        
        const currentPayer = payerSelect.value;
        payerSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
        people.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p; 
            opt.textContent = p;
            payerSelect.appendChild(opt);
        });
        if(people.includes(currentPayer)) payerSelect.value = currentPayer;

        if(participantsContainer.children.length !== people.length && people.length > 0) {
            participantsContainer.innerHTML = '';
            people.forEach(p => {
                const div = document.createElement('div');
                div.className = 'participant-option';
                div.innerHTML = `<input type="checkbox" id="cb_${p}" value="${p}" class="participant-checkbox" checked><label for="cb_${p}">${p}</label>`;
                participantsContainer.appendChild(div);
            });
        }
    }

    function renderExpenses() {
        if (expenses.length === 0) {
            expensesList.innerHTML = '<p style="text-align:center; color:var(--text-muted); padding:20px;">Nenhuma despesa ainda.</p>';
            return;
        }

        expensesList.innerHTML = '';
        expenses.forEach(exp => {
            const div = document.createElement('div');
            div.className = 'expense-item';
            div.innerHTML = `
                <div>
                    <strong>${exp.desc}</strong><br>
                    <small style="color:#888">${exp.payer} pagou R$ ${exp.amount.toFixed(2)}</small>
                </div>
                <div style="display:flex; align-items:center; gap:10px">
                    <span style="color:var(--primary)">R$ ${exp.amount.toFixed(2)}</span>
                    <button class="delete-btn" onclick="removeExpense('${exp.id}')">‚úï</button>
                </div>`;
            expensesList.appendChild(div);
        });
    }

    function calculateAndRenderBalances() {
        if (people.length === 0) {
            balanceList.innerHTML = '<p style="text-align:center; color:var(--text-muted);">Adicione participantes.</p>';
            return;
        }

        let balances = {};
        people.forEach(p => balances[p] = 0);

        expenses.forEach(exp => {
            const share = exp.amount / exp.involved.length;
            if (people.includes(exp.payer)) balances[exp.payer] += exp.amount;
            exp.involved.forEach(p => { 
                if (balances.hasOwnProperty(p)) balances[p] -= share; 
            });
        });

        balanceList.innerHTML = '';
        let hasSaldo = false;
        Object.keys(balances).forEach(p => {
            if(Math.abs(balances[p]) < 0.01) return;
            hasSaldo = true;
            const color = balances[p] > 0 ? 'var(--primary)' : 'var(--danger)';
            const text = balances[p] > 0 ? 'recebe' : 'deve';
            balanceList.innerHTML += `<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #333;">
                <span>${p}</span><span style="color:${color}">${text} R$ ${Math.abs(balances[p]).toFixed(2)}</span>
            </div>`;
        });

        if (!hasSaldo) {
            balanceList.innerHTML = '<p style="text-align:center; color:var(--primary);">Ningu√©m deve nada!</p>';
        }

        let debtors = [];
        let creditors = [];

        for (const [person, amount] of Object.entries(balances)) {
            if (amount < -0.01) debtors.push({ name: person, amount: Math.abs(amount) });
            if (amount > 0.01) creditors.push({ name: person, amount: amount });
        }

        debtors.sort((a, b) => b.amount - a.amount);
        creditors.sort((a, b) => b.amount - a.amount);

        paymentPlanList.innerHTML = '';
        let hasPayments = false;

        let i = 0;
        let j = 0;

        while (i < debtors.length && j < creditors.length) {
            hasPayments = true;
            let debtor = debtors[i];
            let creditor = creditors[j];

            let amountToPay = Math.min(debtor.amount, creditor.amount);

            const div = document.createElement('div');
            div.className = 'payment-plan-item';
            div.innerHTML = `
                <div style="display:flex; align-items:center; width:100%;">
                    <span style="color:var(--danger)">${debtor.name}</span>
                    <span class="pay-arrow">‚ûî</span>
                    <span style="color:var(--primary)">${creditor.name}</span>
                </div>
                <div class="pay-amount">R$ ${amountToPay.toFixed(2)}</div>
            `;
            paymentPlanList.appendChild(div);

            debtor.amount -= amountToPay;
            creditor.amount -= amountToPay;

            if (debtor.amount < 0.01) i++;
            if (creditor.amount < 0.01) j++;
        }

        if (!hasPayments) {
            paymentPlanList.innerHTML = '<p style="text-align:center; color:var(--primary);">Ningu√©m deve nada!</p>';
        }
    }

})();
</script>

</body>
</html>
